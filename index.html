<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›†é»å¡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f5f5f5; }
    .card { background: white; padding: 40px 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 30px;}
    #photo { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 15px; border: 4px solid #06C755; display: none; margin: 0 auto; }
    h2 { margin: 10px 0; color: #333; font-size: 24px;}
    #points { font-size: 80px; color: #06C755; font-weight: bold; margin: 20px 0; }
    #status { color: #aaa; font-size: 12px; margin-top: 20px; word-break: break-all; }
    #error-box { color: red; background: #ffe; padding: 10px; display: none; margin-top: 20px; border: 1px solid red; text-align: left; font-size: 12px;}
  </style>
</head>
<body>

  <div class="card">
    <h2 id="title">é›†é»å¡è®€å–ä¸­...</h2>
    
    <div id="content" style="display:none;">
        <img id="photo" src="">
        <h2 id="name"></h2>
        <p>ç›®å‰é»æ•¸</p>
        <div id="points">...</div>
    </div>
    
    <p id="status">ç³»çµ±æº–å‚™ä¸­...</p>
    <div id="error-box"></div>
  </div>

  <script>
    // âœ… å…¨å±€éŒ¯èª¤æ•æ‰ (å¦‚æœç¨‹å¼ç¢¼å¯«éŒ¯ï¼Œé€™è£¡æœƒé¡¯ç¤º)
    window.onerror = function(msg, source, lineno, colno, error) {
        var box = document.getElementById('error-box');
        box.style.display = 'block';
        box.innerHTML += "ğŸ”´ ç¨‹å¼éŒ¯èª¤:<br>" + msg + "<br>è¡Œæ•¸: " + lineno;
        document.getElementById('status').innerText = "ç¨‹å¼ç¢¼èªæ³•æœ‰èª¤";
    };

    // ==========================================
    // ğŸ‘‡ è«‹åœ¨ä¸‹é¢å°å¿ƒå¡«å…¥ä½ çš„è³‡æ–™
    // ==========================================

    const MY_LIFF_ID = "2008783359-9JsMUCsX";
    
    // ğŸ”´ è«‹æŠŠç¶²å€è²¼åœ¨å…©å€‹å¼•è™Ÿä¸­é–“ï¼Œä¸è¦åˆªæ‰å¼•è™Ÿï¼
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycby4_wyRmzldT5ueF-E0jTA0qPBTlwJTgWHxBkzSldHsSiApLbfSNuHZTA1fOGMfk9DW/exec";

    // ==========================================

    window.onload = async function() {
      const status = document.getElementById('status');
      
      try {
        status.innerText = "1. æ­£åœ¨å•Ÿå‹• LIFF...";
        await liff.init({ liffId: MY_LIFF_ID });
        
        if (liff.isLoggedIn()) {
          status.innerText = "2. å·²ç™»å…¥ï¼Œæ­£åœ¨é€£ç·š Google...";
          showData();
        } else {
          status.innerText = "å°šæœªç™»å…¥ï¼Œè«‹é‡æ•´é é¢æˆ–å¾ LINE é–‹å•Ÿ";
          liff.login();
        }
      } catch (err) {
        status.innerText = "LIFF åˆå§‹åŒ–å¤±æ•—";
        console.error(err);
        document.getElementById('error-box').style.display = 'block';
        document.getElementById('error-box').innerText = "LIFF éŒ¯èª¤: " + err;
      }
    };

    function showData() {
      liff.getProfile().then(profile => {
        document.getElementById('title').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('name').innerText = profile.displayName;
        if(profile.pictureUrl) {
           document.getElementById('photo').src = profile.pictureUrl;
           document.getElementById('photo').style.display = "block";
        }
        
        // å‘¼å« Google
        const params = "?action=getPoints&userId=" + profile.userId + "&displayName=" + encodeURIComponent(profile.displayName);
        
        fetch(GAS_API_URL + params)
        .then(res => res.text())
        .then(text => {
            if(text.includes("Error") || text.includes("script.google.com")) {
                document.getElementById('status').innerText = "Google å›å‚³ç•°å¸¸";
                document.getElementById('error-box').style.display = 'block';
                document.getElementById('error-box').innerText = "å›å‚³å…§å®¹: " + text.substring(0, 100);
            } else {
                document.getElementById('points').innerText = text;
                document.getElementById('status').innerText = "è®€å–å®Œæˆ âœ…";
            }
        })
        .catch(err => {
            document.getElementById('status').innerText = "é€£ç·š Google å¤±æ•—";
            document.getElementById('error-box').style.display = 'block';
            document.getElementById('error-box').innerText = "é€£ç·šéŒ¯èª¤: " + err;
        });
      });
    }
  </script>
</body>
</html>
